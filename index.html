<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Power Apps Deep Link Launcher</title>

<style>
  body {
    margin: 0;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background: #f3f3f3;
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100vh;
  }

  .container {
    text-align: center;
    background: white;
    padding: 40px 24px;
    border-radius: 16px;
    width: 92%;
    max-width: 420px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.08);
  }

  .logo {
    width: 120px;
    margin: 10px auto 20px;
  }

  h2 {
    margin: 8px 0;
    font-weight: 600;
  }

  p {
    color: #666;
    font-size: 14px;
    margin-bottom: 24px;
  }

  .primary-btn {
    background: #0078d4;
    color: white;
    border: none;
    padding: 12px 16px;
    width: 100%;
    border-radius: 8px;
    font-size: 15px;
    cursor: pointer;
  }

  .secondary-btn {
    margin-top: 12px;
    background: none;
    border: none;
    color: #0078d4;
    font-size: 14px;
    cursor: pointer;
  }

  .primary-btn:active {
    transform: scale(0.98);
  }
</style>
</head>

<body>

<div class="container">
  <!-- Replace with your logo image if desired -->
  <img class="logo" src="powerapps-logo.png" alt="Power Apps" />

  <h2>Power Apps</h2>
  <p>
    To get the best experience and full capabilities on your device,
    use the Power Apps mobile app.
  </p>

  <button class="primary-btn" onclick="openApp()">Open the app</button>
  <button class="secondary-btn" onclick="continueBrowser()">Continue in browser</button>
</div>

<script>
// =============================
// CONFIG — default fallback values
// (used if URL parameters are not provided)
// =============================
const defaultParams = {
  orgUrl: "contoso.crm5.dynamics.com",
  appId: "d9f42236-18bd-4051-9532-3e2fdb8eed40",
  tenantId: "TENANT-ID",
  environmentId: "ENVIRONMENT-ID",
  appLogicalName: "crmmodule",
  entityName: "lead",
  recordId: "408574d2-fe7f-4955-bc84-27a0e7a267fe"
};

// =============================
// Browser URL builder (Dynamics web fallback)
// =============================
function buildBrowserUrl(params) {
  return `https://${params.orgUrl}/main.aspx?appid=${params.appId}&pagetype=entityrecord&etn=${params.entityName}&id=${params.recordId}`;
}

const androidStore = "https://play.google.com/store/apps/details?id=com.microsoft.msapps&hl=en";
const iosStore = "https://apps.apple.com/us/app/power-apps/id1047318566";

// =============================
// Utility — read URL parameters
// =============================
function getParamsFromUrl() {
  const p = new URLSearchParams(window.location.search);

  return {
    orgUrl: p.get("orgUrl") || defaultParams.orgUrl,
    appId: p.get("appId") || defaultParams.appId,
    tenantId: p.get("tenantId") || defaultParams.tenantId,
    environmentId: p.get("environmentId") || defaultParams.environmentId,
    appLogicalName: p.get("appLogicalName") || defaultParams.appLogicalName,
    entityName: p.get("etn") || defaultParams.entityName,
    recordId: p.get("id") || defaultParams.recordId
  };
}

// =============================
// Deep link builder
// =============================
function buildAppScheme(params) {
  const base = `ms-apps://${params.orgUrl}_${params.appId}`;

  const query = new URLSearchParams({
    tenantId: params.tenantId,
    environmentId: params.environmentId,
    appLogicalName: params.appLogicalName,
    appType: "AppModule",
    openApp: "true",
    restartApp: "true",
    forceOfflineDataSync: "true",
    pagetype: "entityrecord",
    etn: params.entityName,
    id: params.recordId
  });

  return `${base}?${query.toString()}`;
}

// =============================
// Device detection
// =============================
function detectOS() {
  const ua = navigator.userAgent || navigator.vendor || window.opera;

  if (/android/i.test(ua)) return "android";
  if (/iPad|iPhone|iPod/.test(ua) && !window.MSStream) return "ios";
  return "other";
}

// =============================
// Main actions
// =============================
function openApp() {
  const params = getParamsFromUrl();
  const scheme = buildAppScheme(params);
  const os = detectOS();
  const start = Date.now();

  window.location = scheme;

  setTimeout(() => {
    const elapsed = Date.now() - start;

    if (elapsed < 2000) {
      if (os === "android") window.location = androidStore;
      else if (os === "ios") window.location = iosStore;
    }
  }, 1500);
}

function continueBrowser() {
  const params = getParamsFromUrl();
  const browserUrl = buildBrowserUrl(params);
  window.location = browserUrl;
}
</script>

</body>
</html>
